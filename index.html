<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmacia Digital - Acceso</title>
  <link rel="icon" href="assets/images/logo.png">

  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>

  <div class="container">
    <div class="logo-container">
      <img src="assets/images/logo2.png" alt="Farmacia Digital">
    </div>

    <div id="loginForm">
      <div class="header">
        <h2>Iniciar SesiÃ³n</h2>
        <p>Accede a tu cuenta de Farmacia Digital</p>
      </div>

      <div class="form-group">
        <label for="loginEmail">Correo ElectrÃ³nico o Usuario</label>
        <input type="text" id="loginEmail" placeholder="ejemplo@correo.com o usuario" autocomplete="email">
      </div>

      <div class="form-group">
        <label for="loginPassword">ContraseÃ±a</label>
        <input type="password" id="loginPassword" placeholder="Ingresa tu contraseÃ±a" autocomplete="current-password">
      </div>

      <button onclick="login()">Ingresar</button>

      <div id="loginAlert" class="alert"></div>

      <div class="toggle">
        Â¿No tienes cuenta? <a onclick="toggleForms()">RegÃ­strate aquÃ­</a>
      </div>
    </div>

    <div id="registerForm" style="display: none;">
      <div class="header">
        <h2>Crear Cuenta</h2>
        <p>Ãšnete a Farmacia Digital</p>
      </div>

      <div class="form-group">
        <label for="registerName">Nombre Completo</label>
        <input type="text" id="registerName" placeholder="Juan PÃ©rez" autocomplete="name">
      </div>

      <div class="form-group">
        <label for="registerEmail">Correo ElectrÃ³nico</label>
        <input type="email" id="registerEmail" placeholder="ejemplo@correo.com" autocomplete="email">
      </div>

      <div class="form-group">
        <label for="registerPassword">ContraseÃ±a</label>
        <input type="password" id="registerPassword" placeholder="MÃ­nimo 8 caracteres" autocomplete="new-password"
          oninput="checkPasswordStrength()">
        <div id="passwordStrength" class="password-strength"></div>
      </div>

      <button onclick="register()">Crear Cuenta</button>

      <div id="registerAlert" class="alert"></div>

      <div class="toggle">
        Â¿Ya tienes cuenta? <a onclick="toggleForms()">Inicia sesiÃ³n</a>
      </div>
    </div>
  </div>


  <script>
    // ESTE CÃ“DIGO PERMANECE, YA QUE ES LA ESTRUCTURA BASE DE TU APLICACIÃ“N
    // ----------------------------------------------------------------------
    function getUsers() {
      const stored = localStorage.getItem('users');
      if (!stored) {
        localStorage.setItem('users', JSON.stringify([]));
        return [];
      }
      return JSON.parse(stored);
    }

    function saveUsers(users) {
      localStorage.setItem('users', JSON.stringify(users));
    }

    function toggleForms() {
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");

      if (!loginForm || !registerForm) return;

      if (loginForm.style.display === "none") {
        loginForm.style.display = "block";
        registerForm.style.display = "none";
      } else {
        loginForm.style.display = "none";
        registerForm.style.display = "block";
      }
      clearAlerts();
    }

    function showAlert(elementId, message, type = "info") {
      const alert = document.getElementById(elementId);
      if (!alert) return;

      alert.textContent = message;
      alert.className = `alert alert-${type} show`;

      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }

    function clearAlerts() {
      document.querySelectorAll('.alert').forEach(alert => {
        alert.classList.remove('show');
      });
      document.querySelectorAll('input, select').forEach(input => {
        input.classList.remove('error-input');
      });
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function checkPasswordStrength() {
      const password = document.getElementById("registerPassword").value;
      const strengthDiv = document.getElementById("passwordStrength");
      if (!strengthDiv) return;

      if (password.length === 0) {
        strengthDiv.classList.remove('show');
        return;
      }

      strengthDiv.classList.add('show');

      let strength = 0;
      if (password.length >= 8) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z0-9]/.test(password)) strength++;

      if (strength <= 1) {
        strengthDiv.textContent = "âš ï¸ ContraseÃ±a dÃ©bil";
        strengthDiv.className = "password-strength show strength-weak";
      } else if (strength === 2) {
        strengthDiv.textContent = "âš¡ ContraseÃ±a media";
        strengthDiv.className = "password-strength show strength-medium";
      } else {
        strengthDiv.textContent = "âœ“ ContraseÃ±a fuerte";
        strengthDiv.className = "password-strength show strength-strong";
      }
    }

    // ===== LOGIN (Modificado para separar redirecciÃ³n del admin) =====
    async function login() {
      const correo = document.getElementById('loginEmail').value.trim();
      const contrasena = document.getElementById('loginPassword').value.trim();
      const alert = document.getElementById('loginAlert');

      clearAlerts();

      if (!correo || !contrasena) {
        showAlert('loginAlert', 'Completa todos los campos.', 'warning');
        return;
      }

      try {
        const data = new URLSearchParams();
        data.append("correo", correo);
        data.append("contrasena", contrasena);

        const response = await fetch('php/login.php', {
          method: 'POST',
          body: data
        });

        if (!response.ok) {
          throw new Error(`Error HTTP ${response.status}: Archivo 'login.php' no encontrado.`);
        }

        const result = (await response.text()).trim();

        if (result === "ok") {
          showAlert('loginAlert', 'Acceso exitoso. Redirigiendo...', 'success');
          setTimeout(() => {
            // ðŸ›‘ LÃ“GICA DE REDIRECCIÃ“N AÃ‘ADIDA:
            // Si el correo es el del administrador, va al dashboard de gestiÃ³n.
            if (correo === 'admin@farmacia.com') {
              window.location.href = "modules/dashboard.html"; // <-- Dashboard de Administrador
            } else {
              window.location.href = "modules/usuario-dashboard.html"; // <-- Dashboard de Cliente
            }
          }, 1500);
        } else if (result === "incorrecto") {
          showAlert('loginAlert', 'ContraseÃ±a incorrecta.', 'danger');
        } else if (result === "no_existe") {
          showAlert('loginAlert', 'Usuario no encontrado.', 'danger');
        } else {
          // Captura el error de 'conectado' de conection.php (o cualquier otro error del servidor)
          const errorMsg = result.includes('conectado') 
            ? "Error: Verifica y ELIMINA el 'echo\"conectado\";' de tu conection.php." 
            : `Error en el servidor. Respuesta: ${result.substring(0, 50)}`;
            
          showAlert('loginAlert', errorMsg, 'danger');
        }

      } catch (error) {
        showAlert('loginAlert', `Error de conexiÃ³n con el script PHP: ${error.message}`, 'danger');
        console.error(error);
      }
    }

    // ===== REGISTRO =====
    async function register() {
      const nombre = document.getElementById('registerName').value.trim();
      const correo = document.getElementById('registerEmail').value.trim();
      const contrasena = document.getElementById('registerPassword').value.trim();
      const alert = document.getElementById('registerAlert');

      clearAlerts();

      if (!nombre || !correo || !contrasena) {
        showAlert('registerAlert', 'Completa todos los campos.', 'warning');
        return;
      }

      if (!validateEmail(correo)) {
        showAlert('registerAlert', 'Correo invÃ¡lido.', 'warning');
        return;
      }

      try {
        const data = new URLSearchParams();
        data.append("nombre", nombre);
        data.append("correo", correo);
        data.append("contrasena", contrasena);

        const response = await fetch('php/registro.php', {
          method: 'POST',
          body: data
        });

        if (!response.ok) {
          throw new Error(`Error HTTP ${response.status}: Archivo 'registro.php' no encontrado.`);
        }

        const result = (await response.text()).trim();

        if (result === "ok") {
          showAlert('registerAlert', 'Registro exitoso. Ahora inicia sesiÃ³n.', 'success');
          setTimeout(() => toggleForms(), 1000);
        } else if (result === "existe") {
          showAlert('registerAlert', 'El correo ya estÃ¡ registrado.', 'danger');
        } else if (result === "error") {
          showAlert('registerAlert', 'Error al registrarse en la base de datos.', 'danger');
        } else {
           const errorMsg = result.includes('conectado') 
            ? "Error: Verifica y ELIMINA el 'echo\"conectado\";' de tu conection.php." 
            : `Error desconocido del servidor. Respuesta: ${result.substring(0, 50)}`;
          showAlert('registerAlert', errorMsg, 'danger');
        }

      } catch (error) {
        showAlert('registerAlert', `Error de conexiÃ³n con el script PHP: ${error.message}`, 'danger');
        console.error(error);
      }
    }

    // ===== EVENTOS (Para que Enter funcione en los campos) =====
    document.addEventListener('DOMContentLoaded', function () {
      const loginPassword = document.getElementById('loginPassword');
      const registerPassword = document.getElementById('registerPassword');
      const registerEmail = document.getElementById('registerEmail');

      if (loginPassword) {
        loginPassword.addEventListener('keypress', e => {
          if (e.key === 'Enter') login();
        });
      }

      if (registerPassword) {
        registerPassword.addEventListener('keypress', e => {
          if (e.key === 'Enter') register();
        });
      }

      if (registerEmail) {
        registerEmail.addEventListener('keypress', e => {
          if (e.key === 'Enter') register();
        });
      }
    });
  </script>
</body>
</html>